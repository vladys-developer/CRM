import{u as y,b as E,c as k,j as e}from"./query-CI96NRWO.js";import{r as d}from"./vendor-CfbYkwfL.js";import{s as f,c as r}from"./index-Dy3KKWzm.js";import{g as A,I as $,aC as K,P as L,aD as N,n as F,$ as T,A as P,m as Q,aE as R}from"./ui-BbExp1x0.js";import"./supabase-BZ0N5lZN.js";async function z(t={}){let n=f.from("conversations").select("*, contact:contacts(first_name, last_name, email)").order("last_message_at",{ascending:!1}).limit(50);t.channel&&(n=n.eq("channel",t.channel)),t.status&&(n=n.eq("status",t.status)),t.search&&(n=n.ilike("subject",`%${t.search}%`));const{data:a,error:o}=await n;if(o)throw o;return a??[]}async function O(t){const{data:n,error:a}=await f.from("messages").select("*").eq("conversation_id",t).order("sent_at",{ascending:!0}).limit(100);if(a)throw a;return n??[]}async function W(t,n){const{data:a,error:o}=await f.from("messages").insert({conversation_id:t,direction:"outbound",content:n,sent_at:new Date().toISOString(),sender_name:"Yo",read:!0}).select().single();if(o)throw o;return await f.from("conversations").update({last_message_at:new Date().toISOString()}).eq("id",t),a}const u={all:["conversations"],list:t=>[...u.all,"list",t],messages:t=>[...u.all,"messages",t]};function B(t={}){return y({queryKey:u.list(t),queryFn:()=>z(t),refetchInterval:3e4})}function H(t){return y({queryKey:u.messages(t??""),queryFn:()=>O(t),enabled:!!t,refetchInterval:1e4})}function V(){const t=E();return k({mutationFn:({conversationId:n,content:a})=>W(n,a),onSuccess:(n,a)=>{t.invalidateQueries({queryKey:u.messages(a.conversationId)}),t.invalidateQueries({queryKey:u.all})}})}const x={email:{icon:F,color:"text-blue-500",bgColor:"bg-blue-500/10",label:"Email"},whatsapp:{icon:N,color:"text-green-500",bgColor:"bg-green-500/10",label:"WhatsApp"},phone:{icon:L,color:"text-amber-500",bgColor:"bg-amber-500/10",label:"Teléfono"},internal:{icon:K,color:"text-purple-500",bgColor:"bg-purple-500/10",label:"Interno"}};function Y(t){const n=Date.now()-new Date(t).getTime(),a=Math.floor(n/6e4);if(a<1)return"Ahora";if(a<60)return`${a}m`;const o=Math.floor(a/60);if(o<24)return`${o}h`;const c=Math.floor(o/24);return c<7?`${c}d`:new Date(t).toLocaleDateString("es-ES",{day:"numeric",month:"short"})}function ee(){const[t,n]=d.useState(null),[a,o]=d.useState(""),[c,w]=d.useState(""),[m,p]=d.useState(""),b=d.useRef(null),S={...c?{channel:c}:{},...a?{search:a}:{}},{data:h,isLoading:C}=B(S),{data:g,isLoading:_}=H(t),j=V(),i=h?.find(s=>s.id===t)??null;d.useEffect(()=>{b.current?.scrollIntoView({behavior:"smooth"})},[g]);const v=()=>{!m.trim()||!t||(j.mutate({conversationId:t,content:m.trim()}),p(""))},I=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),v())};return e.jsxs("div",{className:"flex h-[calc(100vh-120px)] gap-0 rounded-xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:r("flex flex-col border-r border-border bg-card w-full sm:w-80 lg:w-96 shrink-0",t&&"hidden sm:flex"),children:[e.jsxs("div",{className:"border-b border-border p-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Inbox"}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(A,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx("input",{type:"text",value:a,onChange:s=>o(s.target.value),placeholder:"Buscar conversaciones...",className:"w-full rounded-lg border border-border bg-background py-2 pl-9 pr-3 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30"})]}),e.jsxs("select",{value:c,onChange:s=>w(s.target.value),className:"rounded-lg border border-border bg-background px-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30",children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"email",children:"Email"}),e.jsx("option",{value:"whatsapp",children:"WhatsApp"}),e.jsx("option",{value:"phone",children:"Teléfono"}),e.jsx("option",{value:"internal",children:"Interno"})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:C?e.jsx("div",{className:"space-y-1 p-2",children:Array.from({length:8}).map((s,l)=>e.jsxs("div",{className:"flex items-center gap-3 rounded-lg p-3",children:[e.jsx("div",{className:"h-10 w-10 animate-pulse rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-1.5",children:[e.jsx("div",{className:"h-3.5 w-32 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"h-3 w-48 animate-pulse rounded bg-muted"})]})]},l))}):(h?.length??0)===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx("div",{className:"rounded-full bg-muted p-4",children:e.jsx($,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("p",{className:"mt-4 text-sm font-medium text-foreground",children:"Sin conversaciones"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Las conversaciones aparecerán aquí"})]}):e.jsx("div",{className:"p-1",children:h?.map(s=>{const l=x[s.channel]||x.internal,q=l.icon,M=t===s.id,D=s.contact?`${s.contact.first_name} ${s.contact.last_name}`:"Sin contacto";return e.jsxs("button",{onClick:()=>n(s.id),className:r("flex w-full items-start gap-3 rounded-lg px-3 py-3 text-left transition-colors",M?"bg-primary/10":"hover:bg-accent/50"),children:[e.jsx("div",{className:r("rounded-full p-2.5 mt-0.5 shrink-0",l.bgColor),children:e.jsx(q,{className:r("h-4 w-4",l.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-foreground truncate",children:D}),e.jsx("span",{className:"text-[10px] text-muted-foreground whitespace-nowrap",children:Y(s.last_message_at)})]}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground truncate",children:s.subject??"Sin asunto"})]})]},s.id)})})})]}),e.jsx("div",{className:r("flex flex-col flex-1",!t&&"hidden sm:flex"),children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 border-b border-border px-4 py-3",children:[e.jsx("button",{onClick:()=>n(null),className:"sm:hidden rounded-lg p-1 text-muted-foreground hover:bg-accent",children:e.jsx(T,{className:"h-5 w-5"})}),i&&(()=>{const s=x[i.channel]||x.internal,l=s.icon;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:r("rounded-full p-2",s.bgColor),children:e.jsx(l,{className:r("h-4 w-4",s.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground truncate",children:i.contact?`${i.contact.first_name} ${i.contact.last_name}`:"Sin contacto"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.label," · ",i.subject??"Sin asunto"]})]}),e.jsx("div",{className:r("rounded-full px-2 py-0.5 text-[10px] font-medium",i.status==="open"?"bg-emerald-500/10 text-emerald-500":i.status==="closed"?"bg-red-500/10 text-red-500":"bg-muted text-muted-foreground"),children:i.status})]})})()]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-4 space-y-3",children:[_?e.jsx("div",{className:"space-y-4",children:Array.from({length:5}).map((s,l)=>e.jsx("div",{className:r("flex",l%2===0?"justify-start":"justify-end"),children:e.jsx("div",{className:r("h-12 w-52 animate-pulse rounded-2xl",l%2===0?"bg-muted":"bg-primary/20")})},l))}):(g?.length??0)===0?e.jsx("div",{className:"flex flex-col items-center justify-center py-12",children:e.jsx("p",{className:"text-xs text-muted-foreground",children:"No hay mensajes en esta conversación"})}):e.jsx(P,{children:g?.map(s=>e.jsx(Q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:r("flex",s.direction==="outbound"?"justify-end":"justify-start"),children:e.jsxs("div",{className:r("max-w-[70%] rounded-2xl px-4 py-2.5",s.direction==="outbound"?"bg-primary text-primary-foreground rounded-br-md":"bg-accent text-foreground rounded-bl-md"),children:[s.direction==="inbound"&&s.sender_name&&e.jsx("p",{className:"text-[10px] font-semibold mb-0.5 opacity-70",children:s.sender_name}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),e.jsx("p",{className:r("text-[10px] mt-1",s.direction==="outbound"?"text-primary-foreground/60":"text-muted-foreground"),children:new Date(s.sent_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]})},s.id))}),e.jsx("div",{ref:b})]}),e.jsx("div",{className:"border-t border-border p-3",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("textarea",{value:m,onChange:s=>p(s.target.value),onKeyDown:I,placeholder:"Escribe un mensaje...",rows:1,className:"flex-1 resize-none rounded-xl border border-border bg-background px-4 py-2.5 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 max-h-32"}),e.jsx("button",{onClick:v,disabled:!m.trim()||j.isPending,className:r("rounded-xl p-2.5 transition-all",m.trim()?"bg-primary text-primary-foreground hover:bg-primary/90":"bg-muted text-muted-foreground"),children:e.jsx(R,{className:"h-4 w-4"})})]})})]}):e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center",children:[e.jsx("div",{className:"rounded-full bg-muted p-5",children:e.jsx(N,{className:"h-10 w-10 text-muted-foreground/30"})}),e.jsx("p",{className:"mt-4 text-sm text-muted-foreground",children:"Selecciona una conversación para empezar"})]})})]})}export{ee as InboxPage};
