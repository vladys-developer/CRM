import{j as e}from"./query-CI96NRWO.js";import{r as x,f as Q,k as Y}from"./vendor-CfbYkwfL.js";import{g as ee,C as ae,u as te,a as $,s as re,K as ne,P as se,D as le,h as ie,S as oe,v as ce,i as de}from"./sortable.esm-HasVT3EM.js";import{c as m,t as w}from"./index-B8FM5hie.js";import{e as ue,c as me,f as xe}from"./useAutomations-Dmlg2cT_.js";import{aL as pe,G as ge,aH as R,aM as be,a2 as he,aN as q,i as F,h as G,n as fe,Z as k,aO as ve,N as je,aP as ye,J as Ne,A as B,m as T,X as we,$ as _e,p as Ce,a3 as Se,ay as Ee,d as ke,aF as Ae,aG as Ie}from"./ui-BbExp1x0.js";import"./supabase-BZ0N5lZN.js";const D={send_email:{label:"Enviar Email",icon:fe,color:"text-blue-500",bg:"bg-blue-500/10"},send_notification:{label:"Notificación",icon:G,color:"text-amber-500",bg:"bg-amber-500/10"},create_activity:{label:"Crear Actividad",icon:F,color:"text-emerald-500",bg:"bg-emerald-500/10"},update_field:{label:"Actualizar Campo",icon:q,color:"text-violet-500",bg:"bg-violet-500/10"},send_whatsapp:{label:"Enviar WhatsApp",icon:he,color:"text-green-500",bg:"bg-green-500/10"},add_tag:{label:"Añadir Etiqueta",icon:be,color:"text-pink-500",bg:"bg-pink-500/10"},move_stage:{label:"Mover Etapa",icon:R,color:"text-cyan-500",bg:"bg-cyan-500/10"},delay:{label:"Esperar",icon:ge,color:"text-orange-500",bg:"bg-orange-500/10"},condition:{label:"Condición",icon:pe,color:"text-purple-500",bg:"bg-purple-500/10"}};function Pe({step:n,index:a,isSelected:r,onSelect:t,onDelete:l}){const{attributes:o,listeners:u,setNodeRef:i,transform:h,transition:j,isDragging:f}=ee({id:n.id}),C={transform:ae.Transform.toString(h),transition:j},p=D[n.action_type]??{label:n.action_type,icon:k,color:"text-muted-foreground",bg:"bg-muted"},v=p.icon,g=Te(n);return e.jsxs("div",{ref:i,style:C,onClick:t,className:m("group relative flex items-center gap-3 rounded-xl border p-4 transition-all cursor-pointer",f&&"opacity-50 shadow-2xl z-50",r?"border-primary bg-primary/5 shadow-md ring-1 ring-primary/20":"border-border bg-card hover:border-primary/30 hover:shadow-sm"),children:[e.jsx("button",{...o,...u,className:"flex h-8 w-8 shrink-0 cursor-grab items-center justify-center rounded-lg text-muted-foreground/40 transition-colors hover:bg-muted hover:text-muted-foreground active:cursor-grabbing",children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx("div",{className:m("flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-xs font-bold",p.bg,p.color),children:a+1}),e.jsx("div",{className:m("flex h-10 w-10 shrink-0 items-center justify-center rounded-xl",p.bg),children:e.jsx(v,{className:m("h-5 w-5",p.color)})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:p.label}),g&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground truncate",children:g})]}),e.jsx("button",{onClick:y=>{y.stopPropagation(),l()},className:"flex h-8 w-8 shrink-0 items-center justify-center rounded-lg text-muted-foreground/40 opacity-0 transition-all hover:bg-destructive/10 hover:text-destructive group-hover:opacity-100",children:e.jsx(je,{className:"h-4 w-4"})})]})}function Te(n){const a=n.config;if(!a||Object.keys(a).length===0)return"Sin configurar";switch(n.action_type){case"send_email":return a.template?`Plantilla: ${a.template}`:a.subject?`Asunto: ${a.subject}`:null;case"delay":return a.duration?`Esperar ${a.duration} ${a.unit??"horas"}`:null;case"condition":return a.field?`Si ${a.field} ${a.operator??"="} ${a.value??""}`:null;case"update_field":return a.field?`${a.field} → ${a.value??""}`:null;case"add_tag":return a.tag?`Etiqueta: ${a.tag}`:null;case"send_notification":return a.message?`"${a.message}"`:null;default:return null}}const z=[{value:"contact_created",label:"Contacto creado"},{value:"deal_stage_changed",label:"Etapa de oportunidad cambiada"},{value:"activity_due",label:"Actividad próxima a vencer"},{value:"contact_birthday",label:"Cumpleaños del contacto"},{value:"manual",label:"Ejecución manual"},{value:"scheduled",label:"Programada (cron)"}],De=[{value:"send_email",label:"Enviar Email",description:"Envía un email automático al contacto"},{value:"send_notification",label:"Notificación",description:"Envía una notificación al equipo"},{value:"create_activity",label:"Crear Actividad",description:"Crea una tarea o actividad nueva"},{value:"update_field",label:"Actualizar Campo",description:"Modifica un campo del registro"},{value:"send_whatsapp",label:"Enviar WhatsApp",description:"Envía un mensaje por WhatsApp Business"},{value:"add_tag",label:"Añadir Etiqueta",description:"Agrega una etiqueta al contacto"},{value:"move_stage",label:"Mover Etapa",description:"Mueve la oportunidad a otra etapa"},{value:"delay",label:"Esperar",description:"Añade un tiempo de espera entre acciones"},{value:"condition",label:"Condición",description:"Bifurca el flujo según una condición"}];function Me({steps:n,selectedStepId:a,onSelectStep:r,onDeleteStep:t,onReorder:l,onAddStep:o}){const u=te($(se,{activationConstraint:{distance:8}}),$(ne,{coordinateGetter:re}));return e.jsx(le,{sensors:u,collisionDetection:ie,onDragEnd:l,children:e.jsx(oe,{items:n.map(i=>i.id),strategy:ce,children:e.jsx("div",{className:"space-y-1",children:n.length===0?e.jsx(O,{onAdd:i=>o(i,0),isFirst:!0}):n.map((i,h)=>e.jsxs("div",{children:[e.jsx(Pe,{step:i,index:h,isSelected:a===i.id,onSelect:()=>r(i.id),onDelete:()=>t(i.id)}),e.jsx("div",{className:"flex items-center justify-center py-1",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(ye,{className:"h-4 w-4 text-muted-foreground/30"}),e.jsx(O,{onAdd:j=>o(j,h+1)})]})})]},i.id))})})})}function O({onAdd:n,isFirst:a}){const[r,t]=x.useState(!1);return e.jsxs("div",{className:"relative flex justify-center",children:[e.jsxs("button",{onClick:()=>t(!r),className:m("flex items-center gap-1.5 rounded-lg border border-dashed px-3 py-1.5 text-xs font-medium transition-all",r?"border-primary bg-primary/5 text-primary":"border-border text-muted-foreground hover:border-primary/40 hover:text-primary",a&&"px-5 py-3 text-sm"),children:[e.jsx(Ne,{className:m("h-3.5 w-3.5",a&&"h-4 w-4")}),a?"Añadir primer paso":"Añadir paso"]}),e.jsx(B,{children:r&&e.jsxs(T.div,{initial:{opacity:0,y:-8,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-8,scale:.95},transition:{duration:.15},className:"absolute top-full z-50 mt-2 w-72 rounded-xl border border-border bg-popover p-2 shadow-xl",children:[e.jsx("p",{className:"mb-2 px-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Tipo de acción"}),e.jsx("div",{className:"space-y-0.5 max-h-64 overflow-y-auto",children:De.map(l=>{const o=D[l.value],u=o?.icon;return e.jsxs("button",{onClick:()=>{n(l.value),t(!1)},className:"flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left transition-colors hover:bg-accent",children:[u&&e.jsx("div",{className:m("flex h-8 w-8 shrink-0 items-center justify-center rounded-lg",o.bg),children:e.jsx(u,{className:m("h-4 w-4",o.color)})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:l.label}),e.jsx("p",{className:"text-[10px] text-muted-foreground truncate",children:l.description})]})]},l.value)})})]})})]})}function $e({step:n,onUpdate:a,onClose:r}){const t=D[n.action_type],l=t?.icon??q;function o(u,i){a({...n.config,[u]:i})}return e.jsxs(T.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},className:"rounded-xl border border-border bg-card shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-5 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:m("flex h-9 w-9 items-center justify-center rounded-lg",t?.bg),children:e.jsx(l,{className:m("h-4.5 w-4.5",t?.color)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:t?.label??n.action_type}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Configuración"})]})]}),e.jsx("button",{onClick:r,className:"flex h-8 w-8 items-center justify-center rounded-lg text-muted-foreground transition-colors hover:bg-muted hover:text-foreground",children:e.jsx(we,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-4 p-5",children:ze(n,o)})]})}function b({label:n,placeholder:a,value:r,onChange:t,type:l="text"}){return e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:n}),e.jsx("input",{type:l,value:r,onChange:o=>t(o.target.value),placeholder:a,className:"h-9 w-full rounded-lg border border-input bg-background px-3 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30"})]})}function _({label:n,value:a,onChange:r,options:t}){return e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:n}),e.jsxs("select",{value:a,onChange:l=>r(l.target.value),className:"h-9 w-full appearance-none rounded-lg border border-input bg-background px-3 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30",children:[e.jsx("option",{value:"",children:"Seleccionar..."}),t.map(l=>e.jsx("option",{value:l.value,children:l.label},l.value))]})]})}function E({label:n,placeholder:a,value:r,onChange:t}){return e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:n}),e.jsx("textarea",{value:r,onChange:l=>t(l.target.value),placeholder:a,rows:3,className:"w-full rounded-lg border border-input bg-background px-3 py-2 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30 resize-none"})]})}function ze(n,a){const r=n.config;switch(n.action_type){case"send_email":return e.jsxs(e.Fragment,{children:[e.jsx(_,{label:"Plantilla",value:r.template??"",onChange:t=>a("template",t),options:[{value:"welcome",label:"Bienvenida"},{value:"follow_up",label:"Seguimiento"},{value:"birthday",label:"Cumpleaños"},{value:"promotion",label:"Promoción"},{value:"custom",label:"Personalizado"}]}),e.jsx(b,{label:"Asunto",placeholder:"Ej: ¡Bienvenido a nuestro CRM!",value:r.subject??"",onChange:t=>a("subject",t)}),e.jsx(E,{label:"Mensaje",placeholder:"Escribe el contenido del email...",value:r.body??"",onChange:t=>a("body",t)})]});case"send_notification":return e.jsxs(e.Fragment,{children:[e.jsx(b,{label:"Título",placeholder:"Ej: Nueva oportunidad creada",value:r.title??"",onChange:t=>a("title",t)}),e.jsx(E,{label:"Mensaje",placeholder:"Descripción de la notificación...",value:r.message??"",onChange:t=>a("message",t)}),e.jsx(_,{label:"Canal",value:r.channel??"",onChange:t=>a("channel",t),options:[{value:"in_app",label:"In-App"},{value:"email",label:"Email"},{value:"slack",label:"Slack"}]})]});case"delay":return e.jsxs(e.Fragment,{children:[e.jsx(b,{label:"Duración",placeholder:"Ej: 24",value:r.duration??"",onChange:t=>a("duration",t),type:"number"}),e.jsx(_,{label:"Unidad",value:r.unit??"",onChange:t=>a("unit",t),options:[{value:"minutos",label:"Minutos"},{value:"horas",label:"Horas"},{value:"dias",label:"Días"}]})]});case"condition":return e.jsxs(e.Fragment,{children:[e.jsx(b,{label:"Campo",placeholder:"Ej: lead_score",value:r.field??"",onChange:t=>a("field",t)}),e.jsx(_,{label:"Operador",value:r.operator??"",onChange:t=>a("operator",t),options:[{value:"=",label:"Igual a"},{value:"!=",label:"Diferente de"},{value:">",label:"Mayor que"},{value:"<",label:"Menor que"},{value:"contains",label:"Contiene"}]}),e.jsx(b,{label:"Valor",placeholder:"Ej: 80",value:r.value??"",onChange:t=>a("value",t)})]});case"update_field":return e.jsxs(e.Fragment,{children:[e.jsx(b,{label:"Campo",placeholder:"Ej: status",value:r.field??"",onChange:t=>a("field",t)}),e.jsx(b,{label:"Nuevo valor",placeholder:"Ej: qualified",value:r.value??"",onChange:t=>a("value",t)})]});case"create_activity":return e.jsxs(e.Fragment,{children:[e.jsx(b,{label:"Título",placeholder:"Ej: Llamada de seguimiento",value:r.title??"",onChange:t=>a("title",t)}),e.jsx(_,{label:"Tipo",value:r.activity_type??"",onChange:t=>a("activity_type",t),options:[{value:"llamada",label:"Llamada"},{value:"email",label:"Email"},{value:"reunion",label:"Reunión"},{value:"tarea",label:"Tarea"}]}),e.jsx(E,{label:"Descripción",placeholder:"Detalles...",value:r.description??"",onChange:t=>a("description",t)})]});case"add_tag":return e.jsx(b,{label:"Etiqueta",placeholder:"Ej: VIP, hot-lead",value:r.tag??"",onChange:t=>a("tag",t)});case"send_whatsapp":return e.jsx(E,{label:"Mensaje",placeholder:"Escribe el mensaje de WhatsApp...",value:r.message??"",onChange:t=>a("message",t)});case"move_stage":return e.jsx(b,{label:"Etapa destino",placeholder:"Ej: Negociación",value:r.stage??"",onChange:t=>a("stage",t)});default:return e.jsx("p",{className:"text-xs text-muted-foreground",children:"No hay campos configurables para este tipo de acción."})}}const Oe={contact_created:F,deal_stage_changed:R,activity_due:G,contact_birthday:Ie,manual:Ae,scheduled:ke},Re={contact_created:"text-emerald-500 bg-emerald-500/10",deal_stage_changed:"text-blue-500 bg-blue-500/10",activity_due:"text-amber-500 bg-amber-500/10",contact_birthday:"text-pink-500 bg-pink-500/10",manual:"text-purple-500 bg-purple-500/10",scheduled:"text-cyan-500 bg-cyan-500/10"};function He(){const n=Q(),{id:a}=Y(),r=!!a,{data:t}=ue(a??""),l=me(),o=xe(),[u,i]=x.useState(""),[h,j]=x.useState(""),[f,C]=x.useState("contact_created"),[p,v]=x.useState([]),[g,y]=x.useState(null),[L,W]=x.useState(!1);if(r&&t&&!L){i(t.name),j(t.description??""),C(t.trigger_type);const s=t.actions??[];v(s.map((c,d)=>({id:`step-${d}-${Date.now()}`,action_type:c.type??"send_email",config:c}))),W(!0)}const A=p.find(s=>s.id===g),U=x.useCallback((s,c)=>{const d={id:`step-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,action_type:s,config:{}};v(N=>{const S=[...N];return S.splice(c,0,d),S}),y(d.id)},[]),H=x.useCallback(s=>{v(c=>c.filter(d=>d.id!==s)),g===s&&y(null)},[g]),K=x.useCallback(s=>{const{active:c,over:d}=s;!d||c.id===d.id||v(N=>{const S=N.findIndex(P=>P.id===c.id),X=N.findIndex(P=>P.id===d.id);return de(N,S,X)})},[]),V=x.useCallback(s=>{g&&v(c=>c.map(d=>d.id===g?{...d,config:s}:d))},[g]),M=l.isPending||o.isPending,Z=()=>{if(!u.trim()){w.error("Introduce un nombre para la automatización");return}const s=p.map(c=>({type:c.action_type,...c.config}));r&&a?o.mutate({id:a,data:{name:u,description:h,trigger_type:f,actions:s,trigger_config:{}}},{onSuccess:()=>{w.success("Automatización actualizada"),n("/automations")},onError:()=>w.error("Error al actualizar")}):l.mutate({name:u,description:h,trigger_type:f,trigger_config:{},conditions:[],actions:s},{onSuccess:()=>{w.success("Automatización creada"),n("/automations")},onError:()=>w.error("Error al crear")})},J=Oe[f]??k,I=Re[f]??"text-muted-foreground bg-muted";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>n("/automations"),className:"flex h-9 w-9 items-center justify-center rounded-lg border border-input text-muted-foreground transition-colors hover:bg-accent hover:text-foreground",children:e.jsx(_e,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-xl gradient-primary",children:e.jsx(k,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold tracking-tight",children:r?"Editar Automatización":"Nueva Automatización"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Diseña tu flujo de trabajo visual"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{className:"flex h-9 items-center gap-2 rounded-lg border border-input px-3 text-sm font-medium text-muted-foreground transition-colors hover:bg-accent hover:text-foreground",children:[e.jsx(Ce,{className:"h-3.5 w-3.5"}),"Preview"]}),e.jsxs("button",{onClick:Z,disabled:M,className:"inline-flex h-9 items-center gap-2 rounded-lg bg-primary px-4 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 disabled:opacity-50",children:[M?e.jsx(Se,{className:"h-4 w-4 animate-spin"}):e.jsx(Ee,{className:"h-4 w-4"}),"Guardar"]})]})]}),e.jsx("div",{className:"rounded-xl border border-border bg-card p-5",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:"Nombre"}),e.jsx("input",{value:u,onChange:s=>i(s.target.value),placeholder:"Ej: Seguimiento de Lead",className:"h-9 w-full rounded-lg border border-input bg-background px-3 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:"Descripción"}),e.jsx("input",{value:h,onChange:s=>j(s.target.value),placeholder:"Breve descripción opcional",className:"h-9 w-full rounded-lg border border-input bg-background px-3 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1.5 block text-xs font-medium text-muted-foreground",children:"Trigger"}),e.jsx("select",{value:f,onChange:s=>C(s.target.value),className:"h-9 w-full appearance-none rounded-lg border border-input bg-background px-3 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30",children:z.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]})}),e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:m("flex items-center gap-3 rounded-xl border-2 border-dashed px-5 py-3",I.split(" ")[1],"border-current"),children:[e.jsx("div",{className:m("flex h-10 w-10 items-center justify-center rounded-xl",I),children:e.jsx(J,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wider text-muted-foreground",children:"Cuando"}),e.jsx("p",{className:m("text-sm font-semibold",I.split(" ")[0]),children:z.find(s=>s.value===f)?.label})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-5",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsx(Me,{steps:p,selectedStepId:g,onSelectStep:y,onDeleteStep:H,onReorder:K,onAddStep:U})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx(B,{mode:"wait",children:A?e.jsx($e,{step:A,onUpdate:V,onClose:()=>y(null)},A.id):e.jsx(T.div,{initial:{opacity:0},animate:{opacity:1},className:"flex h-64 items-center justify-center rounded-xl border border-dashed border-border",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(k,{className:"h-8 w-8 text-muted-foreground/30 mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecciona un paso para configurarlo"})]})},"placeholder")})})]})]})}export{He as AutomationBuilderPage};
