import{u as w,b as v,c as j,j as a}from"./query-CI96NRWO.js";import{r as _}from"./vendor-CfbYkwfL.js";import{s as b,t as f}from"./index-Dy3KKWzm.js";import{A as N,m as C,X as S,a3 as q}from"./ui-BbExp1x0.js";async function k(e={},t={page:1,pageSize:25,sortBy:"created_at",sortOrder:"desc"}){const{page:l,pageSize:s,sortBy:u,sortOrder:m}=t,r=(l-1)*s,x=r+s-1;let n=b.from("companies").select("*",{count:"exact"});e.search&&(n=n.or(`legal_name.ilike.%${e.search}%,commercial_name.ilike.%${e.search}%,nif_cif.ilike.%${e.search}%,email.ilike.%${e.search}%`)),e.status&&(n=n.eq("status",e.status)),e.type&&(n=n.eq("type",e.type)),e.tier&&(n=n.eq("tier",e.tier)),e.industry&&(n=n.eq("industry",e.industry)),n=n.order(u,{ascending:m==="asc"}).range(r,x);const{data:h,error:i,count:d}=await n;if(i)throw i;return{data:h??[],count:d??0,page:l,pageSize:s,totalPages:Math.ceil((d??0)/s)}}async function F(e){const{data:t,error:l}=await b.from("companies").select("*").eq("id",e).single();if(l)throw l;return t}async function B(e){const{data:t,error:l}=await b.from("companies").insert(e).select().single();if(l)throw l;return t}async function P(e,t){const{data:l,error:s}=await b.from("companies").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return l}async function z(e){const{error:t}=await b.from("companies").delete().eq("id",e);if(t)throw t}async function D(e){let t=0,l=0;const s=50;for(let u=0;u<e.length;u+=s){const m=e.slice(u,u+s),{error:r,data:x}=await b.from("companies").insert(m).select("id");r?l+=m.length:t+=x?.length??0}return{success:t,errors:l}}async function O(){const{data:e,error:t}=await b.from("companies").select("*").order("created_at",{ascending:!1}).limit(1e4);if(t)throw t;return e??[]}const y="companies";function L(e={},t={page:1,pageSize:25,sortBy:"created_at",sortOrder:"desc"}){return w({queryKey:[y,e,t],queryFn:()=>k(e,t)})}function $(e){return w({queryKey:[y,e],queryFn:()=>F(e),enabled:!!e})}function A(){const e=v();return j({mutationFn:t=>B(t),onSuccess:()=>{e.invalidateQueries({queryKey:[y]}),f.success("Empresa creada correctamente")},onError:t=>{f.error("Error al crear empresa",{description:t.message})}})}function I(){const e=v();return j({mutationFn:({id:t,updates:l})=>P(t,l),onSuccess:t=>{e.invalidateQueries({queryKey:[y]}),e.setQueryData([y,t.id],t),f.success("Empresa actualizada")},onError:t=>{f.error("Error al actualizar empresa",{description:t.message})}})}function G(){const e=v();return j({mutationFn:t=>z(t),onSuccess:()=>{e.invalidateQueries({queryKey:[y]}),f.success("Empresa eliminada")},onError:t=>{f.error("Error al eliminar empresa",{description:t.message})}})}function R({company:e,onClose:t}){const l=!!e,s=A(),u=I(),m=s.isPending||u.isPending,[r,x]=_.useState({legal_name:e?.legal_name??"",commercial_name:e?.commercial_name??"",nif_cif:e?.nif_cif??"",industry:e?.industry??"",subsector:e?.subsector??"",type:e?.type??"",employee_range:e?.employee_range??"",founded_year:e?.founded_year?.toString()??"",annual_revenue:e?.annual_revenue?.toString()??"",phone:e?.phone??"",email:e?.email??"",website:e?.website??"",status:e?.status??"prospecto",client_type:e?.client_type??"",tier:e?.tier??"",territory:e?.territory??""}),n=(o,c)=>x(g=>({...g,[o]:c}));_.useEffect(()=>{const o=c=>c.key==="Escape"&&t();return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[t]);const h=async o=>{if(o.preventDefault(),!r.legal_name.trim())return;const c={legal_name:r.legal_name.trim(),commercial_name:r.commercial_name.trim()||null,nif_cif:r.nif_cif.trim()||null,industry:r.industry.trim()||null,subsector:r.subsector.trim()||null,type:r.type||null,employee_range:r.employee_range||null,founded_year:r.founded_year?parseInt(r.founded_year):null,annual_revenue:r.annual_revenue?parseFloat(r.annual_revenue):null,phone:r.phone.trim()||null,email:r.email.trim()||null,website:r.website.trim()||null,status:r.status,client_type:r.client_type||null,tier:r.tier||null,territory:r.territory.trim()||null};l?await u.mutateAsync({id:e.id,updates:c}):await s.mutateAsync(c),t()},i=({label:o,field:c,type:g="text",placeholder:p=""})=>a.jsxs("div",{children:[a.jsx("label",{className:"mb-1 block text-xs font-medium text-muted-foreground",children:o}),a.jsx("input",{type:g,value:r[c],onChange:E=>n(c,E.target.value),placeholder:p,className:"h-9 w-full rounded-lg border border-input bg-background px-3 text-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary/30"})]}),d=({label:o,field:c,options:g})=>a.jsxs("div",{children:[a.jsx("label",{className:"mb-1 block text-xs font-medium text-muted-foreground",children:o}),a.jsxs("select",{value:r[c],onChange:p=>n(c,p.target.value),className:"h-9 w-full rounded-lg border border-input bg-background px-3 text-sm outline-none focus:border-primary",children:[a.jsx("option",{value:"",children:"Seleccionar..."}),g.map(p=>a.jsx("option",{value:p.value,children:p.label},p.value))]})]});return a.jsx(N,{children:a.jsx(C.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-start justify-center overflow-y-auto bg-black/50 pt-[5vh] pb-10",onClick:t,children:a.jsxs(C.div,{initial:{opacity:0,y:20,scale:.97},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:20,scale:.97},transition:{type:"spring",duration:.4},onClick:o=>o.stopPropagation(),className:"relative w-full max-w-2xl rounded-2xl border border-border bg-card shadow-xl",children:[a.jsxs("div",{className:"flex items-center justify-between border-b border-border px-6 py-4",children:[a.jsx("h2",{className:"text-lg font-semibold text-foreground",children:l?"Editar Empresa":"Nueva Empresa"}),a.jsx("button",{onClick:t,className:"rounded-lg p-1.5 text-muted-foreground hover:bg-accent",children:a.jsx(S,{className:"h-5 w-5"})})]}),a.jsxs("form",{onSubmit:h,className:"space-y-6 p-6",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"mb-3 text-sm font-semibold text-foreground",children:"Datos Principales"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsx(i,{label:"Razón Social *",field:"legal_name",placeholder:"Empresa S.L."}),a.jsx(i,{label:"Nombre Comercial",field:"commercial_name",placeholder:"MiEmpresa"}),a.jsx(i,{label:"CIF / NIF",field:"nif_cif",placeholder:"B12345678"}),a.jsx(i,{label:"Industria",field:"industry",placeholder:"Tecnología"}),a.jsx(i,{label:"Subsector",field:"subsector",placeholder:"SaaS"}),a.jsx(i,{label:"Territorio",field:"territory",placeholder:"Madrid"})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"mb-3 text-sm font-semibold text-foreground",children:"Clasificación"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsx(d,{label:"Estado",field:"status",options:[{value:"prospecto",label:"Prospecto"},{value:"cliente_activo",label:"Cliente Activo"},{value:"cliente_inactivo",label:"Inactivo"},{value:"ex_cliente",label:"Ex-Cliente"},{value:"partner",label:"Partner"}]}),a.jsx(d,{label:"Tipo",field:"type",options:[{value:"B2B",label:"B2B"},{value:"B2C",label:"B2C"},{value:"B2B2C",label:"B2B2C"}]}),a.jsx(d,{label:"Tier",field:"tier",options:[{value:"platinum",label:"Platinum"},{value:"gold",label:"Gold"},{value:"silver",label:"Silver"},{value:"bronze",label:"Bronze"}]}),a.jsx(d,{label:"Tipo Cliente",field:"client_type",options:[{value:"pequeño",label:"Pequeño"},{value:"mediano",label:"Mediano"},{value:"estratégico",label:"Estratégico"},{value:"enterprise",label:"Enterprise"}]}),a.jsx(d,{label:"Empleados",field:"employee_range",options:[{value:"1-10",label:"1-10"},{value:"11-50",label:"11-50"},{value:"51-200",label:"51-200"},{value:"201-500",label:"201-500"},{value:"500+",label:"500+"}]}),a.jsx(i,{label:"Año de Fundación",field:"founded_year",type:"number",placeholder:"2020"})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"mb-3 text-sm font-semibold text-foreground",children:"Contacto Corporativo"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsx(i,{label:"Email",field:"email",type:"email",placeholder:"info@empresa.com"}),a.jsx(i,{label:"Teléfono",field:"phone",type:"tel",placeholder:"+34 900 000 000"}),a.jsx(i,{label:"Web",field:"website",placeholder:"https://empresa.com"}),a.jsx(i,{label:"Facturación Anual",field:"annual_revenue",type:"number",placeholder:"1000000"})]})]}),a.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-border pt-4",children:[a.jsx("button",{type:"button",onClick:t,className:"h-9 rounded-lg border border-input px-4 text-sm font-medium text-foreground hover:bg-accent",children:"Cancelar"}),a.jsxs("button",{type:"submit",disabled:m||!r.legal_name.trim(),className:"inline-flex h-9 items-center gap-2 rounded-lg bg-primary px-4 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 disabled:opacity-50",children:[m&&a.jsx(q,{className:"h-4 w-4 animate-spin"}),l?"Guardar cambios":"Crear empresa"]})]})]})]})})})}export{R as C,$ as a,D as b,G as c,O as g,L as u};
