import{u as S,j as e}from"./query-CI96NRWO.js";import{s as m,c as D}from"./index-B8FM5hie.js";import{O as q,ai as L,aj as O,f as k,G as K,T as M,D as z,U as G,n as E,P as I,F as W,a6 as $,m as y,b as H,r as b,s as Y,t as A,u as R,Y as F,v,ak as _,w as C,al as U,am as V,an as B,z as j,ao as Q,ap as X,aq as J,ar as Z,as as ee,at as te,au as P}from"./ui-BbExp1x0.js";import"./vendor-CfbYkwfL.js";import"./supabase-BZ0N5lZN.js";async function ae(){const a=new Date,l=new Date(a.getTime()-720*60*60*1e3).toISOString(),{data:i}=await m.from("opportunities").select("value, created_at, updated_at").eq("status","ganada").gte("updated_at",l),{count:o}=await m.from("opportunities").select("*",{count:"exact",head:!0}).eq("status","perdida").gte("updated_at",l),s=i?.length??0,n=i?.reduce((d,t)=>d+(t.value||0),0)??0,c=s>0?Math.round(n/s):0,u=s>0?Math.round(i.reduce((d,t)=>{const r=new Date(t.created_at).getTime(),f=new Date(t.updated_at).getTime();return d+(f-r)/(1e3*60*60*24)},0)/s):0,g=s+(o??0),p=g>0?Math.round(s/g*100):0;return{totalRevenue:n,avgDealSize:c,dealsWon:s,dealsLost:o??0,winRate:p,avgSalesCycle:u}}async function se(){const a=[],l=new Date;for(let i=5;i>=0;i--){const o=new Date(l.getFullYear(),l.getMonth()-i,1),s=o.toISOString(),n=new Date(o.getFullYear(),o.getMonth()+1,0,23,59,59).toISOString(),c=o.toLocaleDateString("es-ES",{month:"short",year:"2-digit"}),{data:u}=await m.from("opportunities").select("value").eq("status","ganada").gte("updated_at",s).lte("updated_at",n),{data:g}=await m.from("opportunities").select("value").eq("status","perdida").gte("updated_at",s).lte("updated_at",n),{data:p}=await m.from("opportunities").select("value").in("status",["abierta","open"]).gte("created_at",s).lte("created_at",n);a.push({month:c,ganado:u?.reduce((d,t)=>d+(t.value||0),0)??0,perdido:g?.reduce((d,t)=>d+(t.value||0),0)??0,pipeline:p?.reduce((d,t)=>d+(t.value||0),0)??0})}return a}async function oe(){const{data:a}=await m.from("pipeline_stages").select("id, name, color, sort_order").order("sort_order");if(!a?.length)return[];const l=[];for(const i of a){const{data:o}=await m.from("opportunities").select("value, created_at").eq("stage_id",i.id).in("status",["abierta","open"]),s=Date.now(),n=o?.length?Math.round(o.reduce((c,u)=>c+(s-new Date(u.created_at).getTime())/(1e3*60*60*24),0)/o.length):0;l.push({stage:i.name,count:o?.length??0,value:o?.reduce((c,u)=>c+(u.value||0),0)??0,avgAge:n,color:i.color||"#94A3B8"})}return l}async function re(){const a=new Date(Date.now()-2592e6).toISOString(),l=["tarea","llamada","email","reunion","nota"],i=[];for(const o of l){const{count:s}=await m.from("activities").select("*",{count:"exact",head:!0}).eq("type",o).gte("created_at",a),{count:n}=await m.from("activities").select("*",{count:"exact",head:!0}).eq("type",o).eq("status","completada").gte("created_at",a);i.push({type:o,count:s??0,completed:n??0})}return i}const x={all:["reports"],salesOverview:()=>[...x.all,"salesOverview"],revenueByMonth:()=>[...x.all,"revenueByMonth"],pipelineHealth:()=>[...x.all,"pipelineHealth"],activityBreakdown:()=>[...x.all,"activityBreakdown"]};function ie(){return S({queryKey:x.salesOverview(),queryFn:ae,staleTime:5*6e4})}function le(){return S({queryKey:x.revenueByMonth(),queryFn:se,staleTime:5*6e4})}function ne(){return S({queryKey:x.pipelineHealth(),queryFn:oe,staleTime:5*6e4})}function de(){return S({queryKey:x.activityBreakdown(),queryFn:re,staleTime:5*6e4})}const w={tarea:{color:"#3B82F6",label:"Tareas",icon:W},llamada:{color:"#22C55E",label:"Llamadas",icon:I},email:{color:"#A855F7",label:"Emails",icon:E},reunion:{color:"#F59E0B",label:"Reuniones",icon:G},nota:{color:"#EC4899",label:"Notas",icon:z}};function h(a){return a>=1e6?`€${(a/1e6).toFixed(1)}M`:a>=1e3?`€${(a/1e3).toFixed(1)}K`:`€${a.toLocaleString("es-ES")}`}function N({height:a="h-64"}){return e.jsx("div",{className:D("animate-pulse rounded-xl bg-muted",a)})}function he(){const{data:a,isLoading:l}=ie(),{data:i,isLoading:o}=le(),{data:s,isLoading:n}=ne(),{data:c,isLoading:u}=de(),g=[{label:"Ingresos (30d)",value:a?h(a.totalRevenue):"€0",icon:q,color:"text-emerald-500",bgColor:"bg-emerald-500/10"},{label:"Deals Ganados",value:a?.dealsWon.toString()??"0",icon:L,color:"text-blue-500",bgColor:"bg-blue-500/10"},{label:"Win Rate",value:`${a?.winRate??0}%`,icon:O,color:(a?.winRate??0)>=50?"text-emerald-500":"text-amber-500",bgColor:(a?.winRate??0)>=50?"bg-emerald-500/10":"bg-amber-500/10"},{label:"Tamaño Medio",value:a?h(a.avgDealSize):"€0",icon:k,color:"text-purple-500",bgColor:"bg-purple-500/10"},{label:"Ciclo de Venta",value:`${a?.avgSalesCycle??0}d`,icon:K,color:"text-amber-500",bgColor:"bg-amber-500/10"},{label:"Deals Perdidos",value:a?.dealsLost.toString()??"0",icon:M,color:"text-red-500",bgColor:"bg-red-500/10"}],p=c?.map(t=>({name:w[t.type]?.label??t.type,value:t.count,color:w[t.type]?.color??"#94A3B8"})).filter(t=>t.value>0)??[],d=c?.map(t=>({type:w[t.type]?.label??t.type,total:t.count,completado:t.completed}))??[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight text-foreground",children:"Reportes"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Análisis de ventas, pipeline y actividad"})]}),e.jsxs("button",{className:"flex items-center gap-2 rounded-xl border border-border bg-card px-4 py-2.5 text-sm font-medium text-foreground transition-all hover:bg-accent",children:[e.jsx($,{className:"h-4 w-4"}),"Exportar"]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-6",children:l?Array.from({length:6}).map((t,r)=>e.jsxs("div",{className:"rounded-xl border border-border bg-card p-4",children:[e.jsx("div",{className:"h-8 w-8 animate-pulse rounded-lg bg-muted mb-3"}),e.jsx("div",{className:"h-6 w-16 animate-pulse rounded bg-muted mb-1"}),e.jsx("div",{className:"h-3 w-20 animate-pulse rounded bg-muted"})]},r)):g.map((t,r)=>{const f=t.icon;return e.jsxs(y.div,{initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{delay:r*.04},className:"rounded-xl border border-border bg-card p-4 transition-all hover:shadow-md",children:[e.jsx("div",{className:D("rounded-lg p-2 w-fit",t.bgColor),children:e.jsx(f,{className:D("h-4 w-4",t.color)})}),e.jsx("p",{className:"mt-3 text-xl font-bold text-foreground",children:t.value}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:t.label})]},t.label)})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-2",children:[e.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.15},className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Tendencia de Ingresos"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Últimos 6 meses"})]}),e.jsx(H,{className:"h-5 w-5 text-muted-foreground"})]}),o?e.jsx(N,{height:"h-72"}):e.jsx(b,{width:"100%",height:300,children:e.jsxs(Y,{data:i,margin:{top:5,right:10,left:0,bottom:0},children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"colorGanado",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#34D399",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"#34D399",stopOpacity:0})]}),e.jsxs("linearGradient",{id:"colorPipeline",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#60A5FA",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"#60A5FA",stopOpacity:0})]})]}),e.jsx(A,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(R,{dataKey:"month",tick:{fontSize:11,fill:"hsl(var(--muted-foreground))"}}),e.jsx(F,{tickFormatter:t=>h(t),tick:{fontSize:11,fill:"hsl(var(--muted-foreground))"}}),e.jsx(v,{formatter:(t,r)=>[h(t??0),r==="ganado"?"Ganado":r==="perdido"?"Perdido":"Pipeline"],contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"12px",fontSize:"13px"}}),e.jsx(_,{formatter:t=>t==="ganado"?"Ganado":t==="perdido"?"Perdido":"Pipeline"}),e.jsx(C,{type:"monotone",dataKey:"ganado",stroke:"#34D399",strokeWidth:2,fill:"url(#colorGanado)"}),e.jsx(C,{type:"monotone",dataKey:"pipeline",stroke:"#60A5FA",strokeWidth:2,fill:"url(#colorPipeline)"}),e.jsx(C,{type:"monotone",dataKey:"perdido",stroke:"#F87171",strokeWidth:2,fill:"transparent",strokeDasharray:"4 4"})]})})]}),e.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Salud del Pipeline"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Oportunidades por etapa"})]}),e.jsx(k,{className:"h-5 w-5 text-muted-foreground"})]}),n?e.jsx(N,{height:"h-72"}):(s?.length??0)===0?e.jsxs("div",{className:"h-72 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(k,{className:"h-8 w-8 mb-2"}),e.jsx("p",{className:"text-sm",children:"Sin datos de pipeline"})]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{width:"100%",height:220,children:e.jsxs(U,{data:s,margin:{top:5,right:10,left:0,bottom:0},children:[e.jsx(A,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(R,{dataKey:"stage",tick:{fontSize:10,fill:"hsl(var(--muted-foreground))"}}),e.jsx(F,{tickFormatter:t=>h(t),tick:{fontSize:11,fill:"hsl(var(--muted-foreground))"}}),e.jsx(v,{formatter:t=>[h(t??0),"Valor"],contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"12px",fontSize:"13px"}}),e.jsx(V,{dataKey:"value",radius:[6,6,0,0],maxBarSize:40,children:s?.map((t,r)=>e.jsx(B,{fill:t.color},r))})]})}),e.jsx("div",{className:"mt-4 space-y-2",children:s?.map(t=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-3 w-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{className:"text-foreground",children:t.stage})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[t.count," deals"]}),e.jsx("span",{className:"font-medium text-foreground",children:h(t.value)}),e.jsxs("span",{title:"Edad promedio",children:[t.avgAge,"d avg"]})]})]},t.stage))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-2",children:[e.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.25},className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Distribución de Actividades"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Últimos 30 días"})]}),e.jsx(j,{className:"h-5 w-5 text-muted-foreground"})]}),u?e.jsx(N,{height:"h-64"}):p.length===0?e.jsxs("div",{className:"h-64 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(j,{className:"h-8 w-8 mb-2"}),e.jsx("p",{className:"text-sm",children:"Sin actividades registradas"})]}):e.jsx(b,{width:"100%",height:280,children:e.jsxs(Q,{children:[e.jsx(X,{data:p,cx:"50%",cy:"50%",outerRadius:100,innerRadius:50,paddingAngle:3,dataKey:"value",label:({name:t,percent:r})=>`${t} ${((r??0)*100).toFixed(0)}%`,children:p.map((t,r)=>e.jsx(B,{fill:t.color,strokeWidth:0},r))}),e.jsx(v,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"12px",fontSize:"13px"}})]})})]}),e.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"rounded-xl border border-border bg-card p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Actividades: Total vs Completado"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Últimos 30 días"})]})}),u?e.jsx(N,{height:"h-64"}):d.every(t=>t.total===0)?e.jsxs("div",{className:"h-64 flex flex-col items-center justify-center text-muted-foreground",children:[e.jsx(j,{className:"h-8 w-8 mb-2"}),e.jsx("p",{className:"text-sm",children:"Sin datos de actividades"})]}):e.jsx(b,{width:"100%",height:280,children:e.jsxs(J,{data:d,children:[e.jsx(Z,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(ee,{dataKey:"type",tick:{fontSize:11,fill:"hsl(var(--muted-foreground))"}}),e.jsx(te,{tick:{fontSize:10,fill:"hsl(var(--muted-foreground))"}}),e.jsx(P,{name:"Total",dataKey:"total",stroke:"#3B82F6",fill:"#3B82F6",fillOpacity:.2}),e.jsx(P,{name:"Completado",dataKey:"completado",stroke:"#34D399",fill:"#34D399",fillOpacity:.3}),e.jsx(_,{}),e.jsx(v,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"12px",fontSize:"13px"}})]})}),e.jsx("div",{className:"mt-4 grid grid-cols-5 gap-2",children:c?.map(t=>{const r=w[t.type],f=r?.icon??j,T=t.count>0?Math.round(t.completed/t.count*100):0;return e.jsxs("div",{className:"rounded-lg border border-border p-2 text-center",children:[e.jsx(f,{className:"h-4 w-4 mx-auto mb-1",style:{color:r?.color}}),e.jsx("p",{className:"text-xs font-bold text-foreground",children:t.count}),e.jsxs("p",{className:"text-[10px] text-muted-foreground",children:[T,"% done"]})]},t.type)})})]})]})]})}export{he as ReportsPage};
