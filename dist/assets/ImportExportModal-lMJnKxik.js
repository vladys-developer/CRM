import{j as e}from"./query-CI96NRWO.js";import{r as b}from"./vendor-CfbYkwfL.js";import{t as j,c as H}from"./index-B8FM5hie.js";import{m as h,H as C,X as U,A as z,a5 as N,a6 as B,q as F,a7 as D,a3 as W,a8 as S,a9 as X}from"./ui-BbExp1x0.js";function Y(i){const a=i.trim().split(/\r?\n/);if(a.length<2)return{headers:[],rows:[],rawRows:[]};const t=q(a[0]),n=[],r=[];for(let s=1;s<a.length;s++){const m=q(a[s]);if(m.every(p=>p===""))continue;n.push(m);const l={};t.forEach((p,x)=>{l[p]=m[x]??""}),r.push(l)}return{headers:t,rows:r,rawRows:n}}function q(i){const a=[];let t="",n=!1;for(let r=0;r<i.length;r++){const s=i[r];n?s==='"'?i[r+1]==='"'?(t+='"',r++):n=!1:t+=s:s==='"'?n=!0:s===","||s===";"?(a.push(t.trim()),t=""):t+=s}return a.push(t.trim()),a}function Q(i,a){const t=a.map(r=>_(r.label)).join(","),n=i.map(r=>a.map(s=>_(String(r[s.key]??""))).join(","));return[t,...n].join(`
`)}function _(i){return i.includes(",")||i.includes('"')||i.includes(`
`)?`"${i.replace(/"/g,'""')}"`:i}function G(i,a){const n=new Blob(["\uFEFF"+i],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=a.endsWith(".csv")?a:`${a}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}const se=[{key:"first_name",label:"Nombre",required:!0},{key:"last_name",label:"Apellido",required:!1},{key:"email",label:"Email",required:!1},{key:"phone_mobile",label:"Teléfono Móvil",required:!1},{key:"phone_landline",label:"Teléfono Fijo",required:!1},{key:"phone_whatsapp",label:"WhatsApp",required:!1},{key:"job_title",label:"Cargo",required:!1},{key:"department",label:"Departamento",required:!1},{key:"status",label:"Estado",required:!1},{key:"source",label:"Fuente",required:!1},{key:"priority",label:"Prioridad",required:!1},{key:"lead_score",label:"Lead Score",required:!1}],ae=[{key:"legal_name",label:"Razón Social",required:!0},{key:"commercial_name",label:"Nombre Comercial",required:!1},{key:"nif_cif",label:"NIF/CIF",required:!1},{key:"industry",label:"Industria",required:!1},{key:"type",label:"Tipo (B2B/B2C)",required:!1},{key:"employee_range",label:"Rango Empleados",required:!1},{key:"phone",label:"Teléfono",required:!1},{key:"email",label:"Email",required:!1},{key:"website",label:"Website",required:!1},{key:"status",label:"Estado",required:!1},{key:"client_type",label:"Tipo Cliente",required:!1},{key:"tier",label:"Tier",required:!1},{key:"territory",label:"Territorio",required:!1}];function J(i,a){return i.map(t=>{const n=t.toLowerCase().trim(),r=a.find(s=>s.key.toLowerCase()===n||s.label.toLowerCase()===n||s.key.toLowerCase().replace(/_/g," ")===n||s.label.toLowerCase().replace(/[áéíóú]/g,m=>({á:"a",é:"e",í:"i",ó:"o",ú:"u"})[m]??m)===n);return{csvHeader:t,dbField:r?.key??""}})}function E(i,a){return i.map(t=>{const n={};return a.forEach(r=>{if(r.dbField&&t[r.csvHeader]!==void 0){const s=t[r.csvHeader].trim();s!==""&&(r.dbField==="lead_score"||r.dbField==="annual_revenue"?n[r.dbField]=Number(s)||0:n[r.dbField]=s)}}),n})}const te=[{key:"first_name",label:"Nombre"},{key:"last_name",label:"Apellido"},{key:"email",label:"Email"},{key:"phone_mobile",label:"Teléfono Móvil"},{key:"job_title",label:"Cargo"},{key:"status",label:"Estado"},{key:"source",label:"Fuente"},{key:"priority",label:"Prioridad"},{key:"lead_score",label:"Lead Score"},{key:"created_at",label:"Fecha Creación"}],le=[{key:"legal_name",label:"Razón Social"},{key:"commercial_name",label:"Nombre Comercial"},{key:"nif_cif",label:"NIF/CIF"},{key:"industry",label:"Industria"},{key:"type",label:"Tipo"},{key:"phone",label:"Teléfono"},{key:"email",label:"Email"},{key:"website",label:"Website"},{key:"status",label:"Estado"},{key:"tier",label:"Tier"},{key:"created_at",label:"Fecha Creación"}];function oe({entityType:i,entityLabel:a,fields:t,exportColumns:n,exportData:r,onImport:s,onClose:m}){const[l,p]=b.useState("choose"),[x,I]=b.useState(null),[f,k]=b.useState([]),[R,T]=b.useState(""),[g,M]=b.useState(null),w=b.useRef(null),L=b.useCallback(()=>{const o=Q(r,n),d=new Date().toISOString().split("T")[0];G(o,`${i}_${d}.csv`),j.success(`${r.length} ${a.toLowerCase()} exportados`),m()},[r,n,i,a,m]),V=b.useCallback(o=>{const d=o.target.files?.[0];if(!d)return;T(d.name);const u=new FileReader;u.onload=c=>{const y=c.target?.result,v=Y(y);if(v.headers.length===0){j.error("El archivo CSV está vacío o no tiene formato válido");return}I(v);const P=J(v.headers,t);k(P),p("mapping")},u.readAsText(d)},[t]),A=(o,d)=>{k(u=>u.map(c=>c.csvHeader===o?{...c,dbField:d}:c))},O=async()=>{if(!x)return;const o=f.filter(c=>c.dbField),u=t.filter(c=>c.required).filter(c=>!o.some(y=>y.dbField===c.key));if(u.length>0){j.error(`Campos requeridos sin mapear: ${u.map(c=>c.label).join(", ")}`);return}p("importing");try{const c=E(x.rows,o),y=await s(c);M(y),p("done")}catch{j.error("Error durante la importación"),p("preview")}},$=x?E(x.rows.slice(0,5),f.filter(o=>o.dbField)):[];return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:e.jsxs(h.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"relative w-full max-w-2xl rounded-2xl bg-card border border-border shadow-2xl mx-4 max-h-[85vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600",children:e.jsx(C,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:l==="choose"?`Importar / Exportar ${a}`:l==="done"?"Importación Completada":`Importar ${a}`}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[l==="choose"&&"Selecciona una acción",l==="upload"&&"Sube un archivo CSV",l==="mapping"&&"Mapea las columnas del CSV",l==="preview"&&"Revisa antes de importar",l==="importing"&&"Importando registros...",l==="done"&&`${g?.success??0} registros importados`]})]})]}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 hover:bg-accent transition-colors",children:e.jsx(U,{className:"h-5 w-5 text-muted-foreground"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs(z,{mode:"wait",children:[l==="choose"&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>p("upload"),className:"group flex flex-col items-center gap-4 rounded-xl border-2 border-dashed border-border p-8 transition-all hover:border-primary hover:bg-primary/5",children:[e.jsx("div",{className:"flex h-14 w-14 items-center justify-center rounded-2xl bg-blue-500/10 text-blue-500 transition-colors group-hover:bg-blue-500/20",children:e.jsx(N,{className:"h-7 w-7"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Importar CSV"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Sube un archivo CSV con los datos"})]})]}),e.jsxs("button",{onClick:L,className:"group flex flex-col items-center gap-4 rounded-xl border-2 border-dashed border-border p-8 transition-all hover:border-emerald-500 hover:bg-emerald-500/5",children:[e.jsx("div",{className:"flex h-14 w-14 items-center justify-center rounded-2xl bg-emerald-500/10 text-emerald-500 transition-colors group-hover:bg-emerald-500/20",children:e.jsx(B,{className:"h-7 w-7"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Exportar CSV"}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["Descarga ",r.length," registros"]})]})]})]},"choose"),l==="upload"&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:[e.jsxs("div",{onClick:()=>w.current?.click(),className:"flex cursor-pointer flex-col items-center gap-4 rounded-xl border-2 border-dashed border-border p-12 transition-all hover:border-primary hover:bg-primary/5",children:[e.jsx(N,{className:"h-10 w-10 text-muted-foreground"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Haz clic para seleccionar un archivo CSV"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Formatos: .csv — separado por comas o punto y coma"})]})]}),e.jsx("input",{ref:w,type:"file",accept:".csv",onChange:V,className:"hidden"})]},"upload"),l==="mapping"&&x&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-blue-500/10 px-4 py-2 text-sm text-blue-600 dark:text-blue-400",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:R}),e.jsxs("span",{className:"text-muted-foreground",children:["— ",x.rows.length," filas detectadas"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-[1fr,auto,1fr] gap-2 px-2 text-xs font-medium uppercase tracking-wider text-muted-foreground",children:[e.jsx("span",{children:"Columna CSV"}),e.jsx("span",{}),e.jsx("span",{children:"Campo CRM"})]}),f.map(o=>e.jsxs("div",{className:"grid grid-cols-[1fr,auto,1fr] items-center gap-2 rounded-lg border border-border px-3 py-2",children:[e.jsx("span",{className:"truncate text-sm font-medium text-foreground",children:o.csvHeader}),e.jsx(F,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:o.dbField,onChange:d=>A(o.csvHeader,d.target.value),className:H("h-8 w-full appearance-none rounded-lg border border-input bg-background px-3 pr-8 text-sm outline-none focus:border-primary",o.dbField?"text-foreground":"text-muted-foreground"),children:[e.jsx("option",{value:"",children:"— Ignorar —"}),t.map(d=>e.jsxs("option",{value:d.key,children:[d.label,d.required?" *":""]},d.key))]}),e.jsx(D,{className:"pointer-events-none absolute right-2 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-muted-foreground"})]})]},o.csvHeader))]})]},"mapping"),l==="preview"&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Vista previa de las primeras 5 filas (de"," ",x?.rows.length??0," totales):"]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-border",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{className:"border-b border-border bg-muted/50",children:f.filter(o=>o.dbField).map(o=>e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground",children:t.find(d=>d.key===o.dbField)?.label??o.dbField},o.dbField))})}),e.jsx("tbody",{children:$.map((o,d)=>e.jsx("tr",{className:"border-b border-border last:border-0",children:f.filter(u=>u.dbField).map(u=>e.jsx("td",{className:"px-3 py-2 text-foreground",children:String(o[u.dbField]??"")},u.dbField))},d))})]})})]},"preview"),l==="importing"&&e.jsxs(h.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center gap-4 py-12",children:[e.jsx(W,{className:"h-10 w-10 animate-spin text-primary"}),e.jsxs("p",{className:"font-medium text-foreground",children:["Importando ",x?.rows.length??0," registros..."]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Esto puede tardar unos segundos"})]},"importing"),l==="done"&&g&&e.jsxs(h.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex flex-col items-center gap-4 py-8",children:[e.jsx("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-emerald-500/10",children:e.jsx(S,{className:"h-8 w-8 text-emerald-500"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground",children:"Importación finalizada"}),e.jsxs("div",{className:"mt-3 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-500",children:[e.jsx(S,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[g.success," correctos"]})]}),g.errors>0&&e.jsxs("div",{className:"flex items-center gap-2 text-red-500",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[g.errors," errores"]})]})]})]})]},"done")]})}),e.jsxs("div",{className:"flex items-center justify-between border-t border-border px-6 py-4",children:[e.jsx("button",{onClick:()=>{l==="mapping"?p("upload"):l==="preview"?p("mapping"):m()},className:"rounded-lg px-4 py-2 text-sm font-medium text-muted-foreground hover:bg-accent transition-colors",children:l==="done"||l==="choose"?"Cerrar":"Atrás"}),l==="mapping"&&e.jsxs("button",{onClick:()=>p("preview"),className:"inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors",children:["Vista Previa",e.jsx(F,{className:"h-4 w-4"})]}),l==="preview"&&e.jsxs("button",{onClick:O,className:"inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700 transition-colors",children:[e.jsx(N,{className:"h-4 w-4"}),"Importar ",x?.rows.length??0," registros"]}),l==="done"&&e.jsx("button",{onClick:m,className:"inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors",children:"Listo"})]})]})})}export{te as C,oe as I,se as a,le as b,ae as c};
