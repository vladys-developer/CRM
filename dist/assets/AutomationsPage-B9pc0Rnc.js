import{j as e}from"./query-CI96NRWO.js";import{f as P,r as h}from"./vendor-CfbYkwfL.js";import{c as i,t as x}from"./index-B8FM5hie.js";import{u as z,a as T,b as D,c as I,d as M}from"./useAutomations-Dmlg2cT_.js";import{af as w,Z as d,J as R,A as _,m as f,l as F,d as B,aF as H,aG as V,h as G,aH as J,i as O,g as U,aI as Z,a3 as C,aJ as q,ae as K,G as X,aK as $,a7 as Q,N as W,V as y,ag as Y}from"./ui-BbExp1x0.js";import"./supabase-BZ0N5lZN.js";const j={contact_created:{label:"Contacto creado",icon:O,color:"text-emerald-500"},deal_stage_changed:{label:"Etapa cambiada",icon:J,color:"text-blue-500"},activity_due:{label:"Actividad pendiente",icon:G,color:"text-amber-500"},contact_birthday:{label:"Cumpleaños",icon:V,color:"text-pink-500"},manual:{label:"Manual",icon:H,color:"text-purple-500"},scheduled:{label:"Programada",icon:B,color:"text-cyan-500"}},ee=[{name:"Seguimiento de Lead",description:"Envía un email de bienvenida cuando se crea un nuevo contacto",trigger_type:"contact_created",actions:[{type:"send_email",template:"welcome"}]},{name:"Notificación de Etapa",description:"Notifica al equipo cuando una oportunidad cambia de etapa",trigger_type:"deal_stage_changed",actions:[{type:"notify_team",channel:"slack"}]},{name:"Recordatorio de Cumpleaños",description:"Envía una felicitación automática en el cumpleaños del contacto",trigger_type:"contact_birthday",actions:[{type:"send_email",template:"birthday"}]},{name:"Seguimiento de Actividad",description:"Recuerda al responsable cuando una actividad está próxima a vencer",trigger_type:"activity_due",actions:[{type:"notify_user",before_hours:24}]}];function le(){const{data:s,isLoading:n,error:m}=z(),u=T(),c=D(),a=I(),o=P(),[l,k]=h.useState(""),[p,S]=h.useState(""),[b,g]=h.useState(!1),[v,E]=h.useState(null),N=(s??[]).filter(t=>!(l&&!t.name.toLowerCase().includes(l.toLowerCase())||p&&t.trigger_type!==p));function A(t){const r={name:t.name,description:t.description,trigger_type:t.trigger_type,trigger_config:{},conditions:[],actions:t.actions};a.mutate(r,{onSuccess:()=>{x.success(`Automatización "${t.name}" creada`),g(!1)},onError:()=>x.error("Error al crear la automatización")})}return m?e.jsx("div",{className:"flex h-[60vh] items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(w,{className:"h-10 w-10 text-destructive mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Error al cargar automatizaciones"})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-xl gradient-primary",children:e.jsx(d,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Automatizaciones"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s?.length??0," automatización",(s?.length??0)!==1?"es":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>o("/automations/new"),className:"inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90",children:[e.jsx(d,{className:"h-4 w-4"}),"Builder Visual"]}),e.jsxs("button",{onClick:()=>g(!b),className:"inline-flex items-center gap-2 rounded-lg border border-input px-4 py-2.5 text-sm font-medium transition-colors hover:bg-accent",children:[e.jsx(R,{className:"h-4 w-4"}),"Plantilla Rápida"]})]})]}),e.jsx(_,{children:b&&e.jsx(f.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsxs("div",{className:"rounded-xl border border-border bg-card p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(F,{className:"h-5 w-5 text-primary"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Plantillas"})]}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:ee.map(t=>{const r=j[t.trigger_type],L=r?.icon??d;return e.jsxs("button",{onClick:()=>A(t),disabled:a.isPending,className:"group flex items-start gap-3 rounded-lg border border-border p-4 text-left transition-all hover:border-primary/40 hover:bg-primary/5 disabled:opacity-50",children:[e.jsx("div",{className:i("mt-0.5 rounded-md p-2",r?.color),children:e.jsx(L,{className:"h-4 w-4"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium group-hover:text-primary transition-colors",children:t.name}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-2",children:t.description})]})]},t.name)})})]})})}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(U,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx("input",{value:l,onChange:t=>k(t.target.value),placeholder:"Buscar automatizaciones...",className:"h-10 w-full rounded-lg border border-input bg-background pl-10 pr-4 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsxs("select",{value:p,onChange:t=>S(t.target.value),className:"h-10 appearance-none rounded-lg border border-input bg-background pl-10 pr-8 text-sm outline-none transition-colors focus:border-primary focus:ring-1 focus:ring-primary/30",children:[e.jsx("option",{value:"",children:"Todos los triggers"}),Object.entries(j).map(([t,r])=>e.jsx("option",{value:t,children:r.label},t))]})]})]}),n?e.jsx("div",{className:"flex h-40 items-center justify-center",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):N.length===0?e.jsx("div",{className:"flex h-40 items-center justify-center rounded-xl border border-dashed border-border",children:e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx(d,{className:"h-8 w-8 text-muted-foreground/40 mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s?.length?"Sin resultados":"Aún no tienes automatizaciones"}),!s?.length&&e.jsx("button",{onClick:()=>g(!0),className:"text-xs text-primary hover:underline",children:"Crear desde plantilla"})]})}):e.jsx("div",{className:"space-y-3",children:N.map(t=>e.jsx(se,{automation:t,onToggle:r=>u.mutate({id:t.id,isActive:r},{onError:()=>x.error("Error al cambiar estado")}),onDelete:()=>{confirm("¿Eliminar esta automatización?")&&c.mutate(t.id,{onSuccess:()=>x.success("Automatización eliminada"),onError:()=>x.error("Error al eliminar")})},expandedLogs:v,onToggleLogs:r=>E(v===r?null:r)},t.id))})]})}function se({automation:s,onToggle:n,onDelete:m,expandedLogs:u,onToggleLogs:c}){const a=j[s.trigger_type]??{label:s.trigger_type,icon:d,color:"text-muted-foreground"},o=a.icon,l=u===s.id;return e.jsxs(f.div,{layout:!0,initial:{opacity:0,y:8},animate:{opacity:1,y:0},className:"rounded-xl border border-border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4",children:[e.jsx("button",{onClick:()=>n(!s.is_active),className:i("relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors",s.is_active?"bg-primary":"bg-muted"),children:e.jsx("span",{className:i("pointer-events-none inline-block h-4 w-4 rounded-full bg-white shadow-sm transition-transform",s.is_active?"translate-x-5":"translate-x-0.5")})}),e.jsx("div",{className:i("flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-muted",a.color),children:e.jsx(o,{className:"h-4 w-4"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:s.name}),e.jsxs("span",{className:i("inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-medium uppercase tracking-wider",s.is_active?"bg-emerald-500/10 text-emerald-600":"bg-muted text-muted-foreground"),children:[s.is_active?e.jsx(q,{className:"h-2.5 w-2.5"}):e.jsx(K,{className:"h-2.5 w-2.5"}),s.is_active?"Activa":"Pausada"]})]}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 truncate",children:s.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-1.5 text-[11px] text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(o,{className:"h-3 w-3"}),a.label]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(d,{className:"h-3 w-3"}),s.execution_count," ejecucion",s.execution_count!==1?"es":""]}),s.last_executed_at&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(X,{className:"h-3 w-3"}),new Date(s.last_executed_at).toLocaleDateString("es-ES")]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>c(s.id),className:"rounded-lg p-2 text-muted-foreground transition-colors hover:bg-muted hover:text-foreground",title:"Ver logs",children:l?e.jsx($,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsx("button",{onClick:m,className:"rounded-lg p-2 text-muted-foreground transition-colors hover:bg-destructive/10 hover:text-destructive",title:"Eliminar",children:e.jsx(W,{className:"h-4 w-4"})})]})]}),e.jsx(_,{children:l&&e.jsx(f.div,{initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx(te,{automationId:s.id})})})]})}function te({automationId:s}){const{data:n,isLoading:m}=M(s),u={success:Y,error:w,skipped:y},c={success:"text-emerald-500",error:"text-destructive",skipped:"text-amber-500"};return e.jsxs("div",{className:"border-t border-border bg-muted/30 px-4 py-3",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Historial de ejecuciones"}),m?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(C,{className:"h-4 w-4 animate-spin text-muted-foreground"})}):n?.length?e.jsx("div",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:n.map(a=>{const o=u[a.status]??y;return e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(o,{className:i("h-3.5 w-3.5 shrink-0",c[a.status])}),e.jsx("span",{className:"text-muted-foreground",children:new Date(a.executed_at).toLocaleString("es-ES",{dateStyle:"short",timeStyle:"short"})}),e.jsx("span",{className:i("font-medium",c[a.status]),children:a.status==="success"?"Éxito":a.status==="error"?"Error":"Omitida"}),a.error_message&&e.jsx("span",{className:"text-destructive/70 truncate",children:a.error_message})]},a.id)})}):e.jsx("p",{className:"text-xs text-muted-foreground/60 py-2",children:"Sin ejecuciones registradas"})]})}export{le as AutomationsPage};
