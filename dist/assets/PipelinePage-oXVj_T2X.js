import{j as e}from"./query-CI96NRWO.js";import{r as g}from"./vendor-CfbYkwfL.js";import{u as _,a as S,D as C,c as D,b as k,d as O,P,e as E,S as A,v as B,f as I,C as M}from"./sortable.esm-HasVT3EM.js";import{a as x,c as m,f as R}from"./index-Dy3KKWzm.js";import{a as T,u as z,b as K}from"./useOpportunities-DmQGSky2.js";import{J as b,B as L,j as V,d as $}from"./ui-BbExp1x0.js";import"./supabase-BZ0N5lZN.js";function j({opportunity:r,isDragging:t=!1,className:n}){const{attributes:i,listeners:l,setNodeRef:d,transform:o}=I({id:r.id,data:{opportunity:r}}),c={transform:M.Translate.toString(o)};return e.jsxs("div",{ref:d,style:c,...i,...l,className:m("group relative flex cursor-grab flex-col rounded-xl border bg-card p-4 shadow-sm transition-all hover:shadow-md hover:border-primary/20 hover:-translate-y-0.5",t?"z-50 cursor-grabbing opacity-50 rotate-3 scale-105 shadow-xl ring-2 ring-primary/40":"border-border/60",n),children:[e.jsx("div",{className:m("absolute left-0 top-3 bottom-3 w-1 rounded-r-full opacity-60 transition-opacity group-hover:opacity-100",r.priority==="high"?"bg-red-500":r.priority==="medium"?"bg-yellow-500":"bg-blue-500")}),e.jsxs("div",{className:"pl-3",children:[e.jsx("div",{className:"mb-2 flex items-start justify-between gap-2",children:e.jsx("h4",{className:"line-clamp-2 text-sm font-semibold text-foreground group-hover:text-primary transition-colors",children:r.name})}),e.jsx("div",{className:"mb-3",children:e.jsx("p",{className:"text-lg font-bold tracking-tight text-foreground",children:x(r.monetary_value)})}),e.jsxs("div",{className:"space-y-1.5",children:[r.company&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground/80",children:[e.jsx(L,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:r.company.commercial_name||r.company.legal_name})]}),r.contact&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground/80",children:[e.jsx(V,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:`${r.contact.first_name} ${r.contact.last_name??""}`.trim()})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between border-t border-border/40 pt-3",children:[r.estimated_close_date&&e.jsxs("div",{className:"flex items-center gap-1.5 text-[10px] font-medium text-muted-foreground",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{children:R(r.estimated_close_date)})]}),e.jsx("div",{className:m("rounded-full px-2 py-0.5 text-[10px] font-medium border",r.priority==="high"?"bg-red-500/10 text-red-600 border-red-500/20":r.priority==="medium"?"bg-yellow-500/10 text-yellow-600 border-yellow-500/20":"bg-blue-500/10 text-blue-600 border-blue-500/20"),children:r.priority==="high"?"Alta":r.priority==="medium"?"Media":"Baja"})]})]})]})}function J({stage:r,opportunities:t}){const{isOver:n,setNodeRef:i}=E({id:r.id}),l=t.reduce((o,c)=>o+(c.monetary_value||0),0),d=t.length;return e.jsxs("div",{ref:i,className:m("flex h-full min-w-0 flex-1 flex-col rounded-xl border transition-all duration-300",n?"bg-accent/50 ring-2 ring-primary/20":"bg-card/30 hover:bg-card/50","backdrop-blur-sm"),style:{borderColor:n?r.color:"transparent",borderTopWidth:3,borderTopColor:r.color},children:[e.jsxs("div",{className:"flex h-14 shrink-0 items-center justify-between border-b border-border/40 px-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full shadow-[0_0_8px_currentColor]",style:{backgroundColor:r.color,color:r.color}}),e.jsx("h3",{className:"font-medium text-foreground text-sm tracking-wide line-clamp-1",title:r.name,children:r.name}),e.jsx("span",{className:"flex h-5 min-w-5 items-center justify-center rounded-full bg-primary/10 px-1.5 text-[10px] font-medium text-primary",children:d})]}),l>0&&e.jsx("span",{className:"text-[10px] font-medium text-muted-foreground bg-muted/50 px-2 py-0.5 rounded-md",children:x(l)})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 scrollbar-thin scrollbar-thumb-muted-foreground/10 hover:scrollbar-thumb-muted-foreground/20",children:[e.jsx(A,{items:t.map(o=>o.id),strategy:B,children:e.jsx("div",{className:"flex flex-col gap-2.5",children:t.map(o=>e.jsx(j,{opportunity:o},o.id))})}),t.length===0&&e.jsxs("div",{className:"flex h-32 flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-border/40 bg-muted/5 text-center transition-colors hover:bg-muted/10",children:[e.jsx("div",{className:"rounded-full bg-muted/20 p-2 text-muted-foreground/40",children:e.jsx(b,{className:"h-5 w-5 opacity-50"})}),e.jsx("p",{className:"text-xs font-medium text-muted-foreground/60",children:"Sin oportunidades"})]})]})]})}function X(){const{data:r}=T("00000000-0000-0000-0000-000000000001"),{data:t,isLoading:n}=z({pipeline_id:"00000000-0000-0000-0000-000000000001",status:"abierto"},{page:1,pageSize:200,sortBy:"created_at",sortOrder:"desc"}),i=K(),[l,d]=g.useState(null),o=_(S(P,{activationConstraint:{distance:5}})),c=g.useMemo(()=>{const s={};for(const a of r??[])s[a.id]=[];for(const a of t?.data??[])a.stage_id&&s[a.stage_id]&&s[a.stage_id].push(a);return s},[r,t?.data]),v=s=>{d(s.active.data.current?.opportunity??null)},N=s=>{d(null);const{active:a,over:u}=s;if(!u||!a)return;const f=a.id,p=u.id,h=t?.data.find(w=>w.id===f);h&&h.stage_id!==p&&i.mutate({id:f,stageId:p})},y=(t?.data??[]).reduce((s,a)=>s+(a.monetary_value||0),0);return e.jsxs("div",{className:"flex h-[calc(100vh-5rem)] flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between pb-6 pt-2",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-foreground sm:text-4xl bg-gradient-to-r from-foreground to-foreground/60 bg-clip-text text-transparent",children:"Pipeline"}),e.jsxs("p",{className:"mt-1 text-sm text-muted-foreground font-medium",children:[t?.count??0," oportunidades ",e.jsx("span",{className:"mx-2 text-border/60",children:"|"})," ",x(y)," en pipeline"]})]}),e.jsxs("button",{className:"inline-flex items-center gap-2 rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-primary-foreground shadow-lg shadow-primary/25 transition-all hover:bg-primary/90 hover:shadow-primary/40 hover:-translate-y-0.5 active:translate-y-0",children:[e.jsx(b,{className:"h-4.5 w-4.5 stroke-[2.5]"}),"Nueva Oportunidad"]})]}),n?e.jsx("div",{className:"flex flex-1 gap-3 pb-4",children:Array.from({length:6}).map((s,a)=>e.jsx("div",{className:"h-full min-w-0 flex-1 animate-pulse rounded-xl bg-muted/50"},a))}):e.jsxs(C,{sensors:o,collisionDetection:D,onDragStart:v,onDragEnd:N,children:[e.jsx("div",{className:"flex flex-1 gap-3 pb-4",children:(r??[]).map(s=>e.jsx(J,{stage:s,opportunities:c[s.id]??[]},s.id))}),e.jsx(k,{dropAnimation:{sideEffects:O({styles:{active:{opacity:"0.5"}}})},children:l?e.jsxs("div",{className:"w-72",children:[" ",e.jsx(j,{opportunity:l,isDragging:!0})]}):null})]})]})}export{X as PipelinePage};
