import{j as e}from"./query-CI96NRWO.js";import{L as S,k as C,f as k,r as f}from"./vendor-CfbYkwfL.js";import{u as L}from"./useActivities-zY1hKLZ-.js";import{u as P}from"./useOpportunities-BM8L7a44.js";import{c as u,g as A,f as D,a as b}from"./index-B8FM5hie.js";import{T as E,m as g,j as O,O as I,G as T,Q as M,V as $,W as R,_ as q,q as F,$ as V,a0 as W,N as U,n as z,P as B,d as G,a1 as H,a2 as Q,D as Y}from"./ui-BbExp1x0.js";import{d as J,a as K,C as X,P as Z,b as ee}from"./ContactFormModal-BoZeFhqg.js";import"./supabase-BZ0N5lZN.js";function j(t){let i=0,s=0,a=0;t.email&&(i+=10),(t.phone_mobile||t.phone_landline)&&(i+=10),t.job_title&&(i+=5),t.company_id&&(i+=5),t.address&&(i+=5),t.preferred_language&&(i+=5);const r=Math.min(20,Math.floor((t.total_revenue_generated||0)/1e3));s+=r;const o=t.days_since_last_interaction||0,n=Math.floor(o/7);a=Math.min(20,n);const d=i+s-a,c=Math.max(0,Math.min(100,d));let m="cold";return c>=70?m="hot":c>=40&&(m="warm"),{totalScore:c,factors:{profile:i,activity:0,revenue:s,decay:-a},level:m}}function se({contact:t}){const{totalScore:i,factors:s,level:a}=j(t),o=(n=>n>=70?"text-emerald-500 stroke-emerald-500":n>=40?"text-amber-500 stroke-amber-500":"text-blue-500 stroke-blue-500")(i);return e.jsxs("div",{className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4"}),"AI Lead Score"]}),e.jsx("span",{className:u("text-xs font-medium px-2 py-0.5 rounded-full uppercase",a==="hot"?"bg-emerald-500/10 text-emerald-500":a==="warm"?"bg-amber-500/10 text-amber-500":"bg-blue-500/10 text-blue-500"),children:a==="hot"?"Alto Potencial":a==="warm"?"En Seguimiento":"Frío"})]}),e.jsxs("div",{className:"mt-6 flex flex-col items-center",children:[e.jsxs("div",{className:"relative h-32 w-32",children:[e.jsxs("svg",{className:"h-full w-full -rotate-90",viewBox:"0 0 120 120",children:[e.jsx("circle",{cx:"60",cy:"60",r:"50",fill:"none",stroke:"hsl(var(--muted))",strokeWidth:"8",className:"opacity-20"}),e.jsx(g.circle,{initial:{strokeDashoffset:314},animate:{strokeDashoffset:314-i/100*314},transition:{duration:1.5,ease:"easeOut"},cx:"60",cy:"60",r:"50",fill:"none",strokeWidth:"8",strokeLinecap:"round",strokeDasharray:"314",className:o})]}),e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:e.jsx("span",{className:u("text-3xl font-bold",o.split(" ")[0]),children:i})})]}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Puntuación basada en IA"})]}),e.jsxs("div",{className:"mt-6 space-y-3 border-t border-border pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(O,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Perfil"})]}),e.jsxs("span",{className:"font-medium text-emerald-500",children:["+",s.profile]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(I,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Valor"})]}),e.jsxs("span",{className:"font-medium text-emerald-500",children:["+",s.revenue]})]}),s.decay<0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(T,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Inactividad"})]}),e.jsx("span",{className:"font-medium text-red-500",children:s.decay})]})]})]})}function te(t,i=[],s=[]){const a=[],r=j(t),o=t.days_since_last_interaction||0,n=s.some(d=>d.status==="abierto");return r.totalScore>70&&!n&&a.push({id:"create-opp",type:"action",title:"Oportunidad Detectada",description:`Este contacto tiene un alto Lead Score (${r.totalScore}) pero no tiene oportunidades abiertas. Considera abrir una negociación.`,actionLabel:"Crear Oportunidad",actionLink:"/opportunities/new",priority:"high"}),o>14&&r.totalScore>40&&a.push({id:"schedule-call",type:"warning",title:"Riesgo de Enfriamiento",description:`Han pasado ${o} días desde la última interacción. Programa una llamada para mantener el interés.`,actionLabel:"Agendar Llamada",actionLink:"/calendar/new",priority:"medium"}),t.status==="nuevo"&&!t.email&&!t.phone_mobile?a.push({id:"enrich-data",type:"action",title:"Faltan Datos de Contacto",description:"El perfil está incompleto. Intenta conseguir un email o teléfono para calificar el lead.",actionLabel:"Editar Perfil",actionLink:`/contacts/${t.id}/edit`,priority:"high"}):t.status==="nuevo"&&a.push({id:"qualify-lead",type:"insight",title:"Calificar Lead",description:"Este contacto es nuevo. Revisa su perfil y determina si es un prospecto viable.",actionLabel:"Cambiar Estado",actionLink:"#status",priority:"medium"}),n&&r.totalScore>80&&a.push({id:"close-deal",type:"insight",title:"Alta Probabilidad de Cierre",description:"Las señales indican una alta intención de compra. Prioriza el cierre de su oportunidad activa.",priority:"high"}),a}function ae({contact:t,activities:i=[],opportunities:s=[]}){const a=te(t,i,s);return a.length===0?null:e.jsxs("div",{className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground flex items-center gap-2 mb-4",children:[e.jsx(M,{className:"h-4 w-4 text-amber-500"}),"Sugerencias de IA"]}),e.jsx("div",{className:"space-y-3",children:a.map((r,o)=>{const n=r.type==="warning"?$:r.type==="action"?R:q,d=r.priority==="high"?"text-red-500 bg-red-500/10":r.priority==="medium"?"text-amber-500 bg-amber-500/10":"text-blue-500 bg-blue-500/10";return e.jsx(g.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:o*.1},className:"rounded-lg border border-border bg-background p-3",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:u("flex h-8 w-8 shrink-0 items-center justify-center rounded-lg",d),children:e.jsx(n,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-foreground",children:r.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:r.description}),r.actionLabel&&e.jsxs(S,{to:r.actionLink??"#",className:"mt-2 inline-flex items-center gap-1 text-xs font-medium text-primary hover:text-primary/80",children:[r.actionLabel,e.jsx(F,{className:"h-3 w-3"})]})]})]})},r.id)})})]})}function xe(){const{id:t}=C(),i=k(),{data:s,isLoading:a}=J(t),r=K(),[o,n]=f.useState(!1),[d,c]=f.useState("timeline"),{data:m}=L(s?{related_to_id:s.id,related_to_type:"contact",pageSize:20}:{}),{data:v}=P(s?{primary_contact_id:s.id}:{}),N=m?.data||[],y=v?.data||[];if(a)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"h-8 w-40 animate-pulse rounded bg-muted"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsx("div",{className:"h-40 animate-pulse rounded-xl bg-muted"}),e.jsx("div",{className:"h-60 animate-pulse rounded-xl bg-muted"})]}),e.jsx("div",{className:"h-80 animate-pulse rounded-xl bg-muted"})]})]});if(!s)return e.jsxs("div",{className:"flex h-[60vh] flex-col items-center justify-center",children:[e.jsx("p",{className:"text-lg font-medium text-foreground",children:"Contacto no encontrado"}),e.jsx("button",{onClick:()=>i("/contacts"),className:"mt-4 text-sm text-primary hover:text-primary/80",children:"Volver a contactos"})]});const x=X.find(l=>l.value===s.status),p=Z.find(l=>l.value===s.priority),h=`${s.first_name} ${s.last_name??""}`.trim(),_=async()=>{window.confirm("¿Estás seguro de que quieres eliminar este contacto?")&&(await r.mutateAsync(s.id),i("/contacts"))},w=[{id:"timeline",label:"Timeline"},{id:"details",label:"Detalles"},{id:"notes",label:"Notas"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("button",{onClick:()=>i("/contacts"),className:"inline-flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-foreground",children:[e.jsx(V,{className:"h-4 w-4"}),"Contactos"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(ae,{contact:s,activities:N,opportunities:y}),e.jsxs("div",{className:"rounded-xl border border-border bg-card p-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex h-16 w-16 items-center justify-center rounded-2xl bg-primary/10 text-xl font-bold text-primary",children:A(h)}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-foreground",children:h}),s.job_title&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.job_title}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsxs("span",{className:"inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium",style:{backgroundColor:`${x?.color}15`,color:x?.color},children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full",style:{backgroundColor:x?.color}}),x?.label]}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium",style:{backgroundColor:`${p?.color}15`,color:p?.color},children:["Prioridad ",p?.label]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>n(!0),className:"flex h-9 items-center gap-2 rounded-lg border border-input px-3 text-sm font-medium transition-colors hover:bg-accent",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Editar"]}),e.jsx("button",{onClick:_,className:"flex h-9 w-9 items-center justify-center rounded-lg border border-input text-destructive transition-colors hover:bg-destructive/10",children:e.jsx(U,{className:"h-3.5 w-3.5"})})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 gap-4 sm:grid-cols-4",children:[s.email&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(z,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{className:"truncate",children:s.email})]}),s.phone_mobile&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(B,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:s.phone_mobile})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(G,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:D(s.created_at)})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(H,{className:"h-4 w-4 shrink-0"}),e.jsxs("span",{children:["Score: ",s.lead_score]})]})]})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-card",children:[e.jsx("div",{className:"flex border-b border-border px-4",children:w.map(l=>e.jsxs("button",{onClick:()=>c(l.id),className:u("relative px-4 py-3 text-sm font-medium transition-colors",d===l.id?"text-primary":"text-muted-foreground hover:text-foreground"),children:[l.label,d===l.id&&e.jsx("span",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-primary"})]},l.id))}),e.jsxs("div",{className:"p-6",children:[d==="timeline"&&e.jsxs("div",{className:"flex flex-col items-center py-12",children:[e.jsx("div",{className:"rounded-full bg-muted p-3",children:e.jsx(Q,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"mt-3 text-sm font-medium text-foreground",children:"Sin actividad"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Las interacciones con este contacto aparecerán aquí"})]}),d==="details"&&e.jsx("div",{className:"grid grid-cols-2 gap-4",children:[{label:"Nombre",value:s.first_name},{label:"Apellido",value:s.last_name},{label:"Email",value:s.email},{label:"Email secundario",value:s.email_secondary},{label:"Móvil",value:s.phone_mobile},{label:"Fijo",value:s.phone_landline},{label:"WhatsApp",value:s.phone_whatsapp},{label:"Cargo",value:s.job_title},{label:"Departamento",value:s.department},{label:"Idioma",value:s.preferred_language},{label:"Fuente",value:s.source},{label:"LTV",value:s.lifetime_value?b(s.lifetime_value):null}].map(l=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:l.label}),e.jsx("p",{className:"mt-0.5 text-sm text-foreground",children:l.value??e.jsx("span",{className:"text-muted-foreground/50",children:"—"})})]},l.label))}),d==="notes"&&e.jsxs("div",{className:"flex flex-col items-center py-12",children:[e.jsx("div",{className:"rounded-full bg-muted p-3",children:e.jsx(Y,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("p",{className:"mt-3 text-sm font-medium text-foreground",children:"Sin notas"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Agrega notas para este contacto"})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(se,{contact:s}),e.jsxs("div",{className:"rounded-xl border border-border bg-card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Métricas"}),e.jsx("div",{className:"mt-4 space-y-3",children:[{label:"Revenue Generado",value:b(s.total_revenue_generated)},{label:"Oportunidades Activas",value:s.active_opportunities_count.toString()},{label:"Prob. Conversión",value:`${s.conversion_probability}%`},{label:"Engagement Score",value:s.engagement_score.toString()},{label:"Días sin interacción",value:s.days_since_last_interaction.toString()}].map(l=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:l.label}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.value})]},l.label))})]})]})]}),o&&e.jsx(ee,{contact:s,onClose:()=>n(!1)})]})}export{xe as ContactDetailPage};
