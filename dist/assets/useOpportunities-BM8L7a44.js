import{u,b as g,c as l}from"./query-CI96NRWO.js";import{s as i,t as q}from"./index-B8FM5hie.js";async function f(e){let t=i.from("pipeline_stages").select("*").order("sort_order",{ascending:!0});t=t.eq("pipeline_id",e);const{data:o,error:a}=await t;if(a)throw a;return o??[]}async function S(e={},t={page:1,pageSize:50,sortBy:"created_at",sortOrder:"desc"}){const{page:o,pageSize:a,sortBy:d,sortOrder:y}=t,n=(o-1)*a,_=n+a-1;let r=i.from("opportunities").select(`*, stage:pipeline_stages(id, name, color, sort_order, close_probability),
       contact:contacts!primary_contact_id(id, first_name, last_name, email),
       company:companies!company_id(id, legal_name, commercial_name)`,{count:"exact"});e.search&&(r=r.ilike("name",`%${e.search}%`)),e.status&&(r=r.eq("status",e.status)),e.priority&&(r=r.eq("priority",e.priority)),e.pipeline_id&&(r=r.eq("pipeline_id",e.pipeline_id)),e.stage_id&&(r=r.eq("stage_id",e.stage_id)),e.primary_contact_id&&(r=r.eq("primary_contact_id",e.primary_contact_id)),r=r.order(d,{ascending:y==="asc"}).range(n,_);const{data:m,error:s,count:c}=await r;if(s)throw s;return{data:m??[],count:c??0,page:o,pageSize:a,totalPages:Math.ceil((c??0)/a)}}async function O(e,t){const{data:o,error:a}=await i.from("opportunities").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return o}async function w(e,t){return O(e,{stage_id:t})}const p="opportunities",h="pipeline-stages";function K(e){return u({queryKey:[h,e],queryFn:()=>f(e)})}function P(e={},t={page:1,pageSize:50,sortBy:"created_at",sortOrder:"desc"}){return u({queryKey:[p,e,t],queryFn:()=>S(e,t)})}function v(){const e=g();return l({mutationFn:({id:t,stageId:o})=>w(t,o),onSuccess:()=>{e.invalidateQueries({queryKey:[p]})},onError:t=>q.error("Error al mover oportunidad",{description:t.message})})}export{K as a,v as b,P as u};
